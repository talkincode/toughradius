name: toughradius release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: read

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Build Frontend
        working-directory: ./web
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm ci
          
          echo "ðŸ” Running TypeScript type check..."
          npm run type-check
          
          echo "ðŸ—ï¸ Building frontend for production..."
          npm run build
          
          echo "âœ… Frontend build completed!"
          ls -lah dist/

      - name: Verify Frontend Build
        run: |
          echo "ðŸ” Verifying frontend build output..."
          
          # Check if dist/admin directory exists
          if [ ! -d "web/dist/admin" ]; then
            echo "âŒ Error: web/dist/admin directory not found!"
            exit 1
          fi
          
          # Check if index.html exists
          if [ ! -f "web/dist/admin/index.html" ]; then
            echo "âŒ Error: web/dist/admin/index.html not found!"
            exit 1
          fi
          
          # Check if assets directory exists and has files
          if [ ! -d "web/dist/admin/assets" ]; then
            echo "âŒ Error: web/dist/admin/assets directory not found!"
            exit 1
          fi
          
          ASSET_COUNT=$(find web/dist/admin/assets -type f | wc -l)
          if [ "$ASSET_COUNT" -lt 1 ]; then
            echo "âŒ Error: No assets found in web/dist/admin/assets!"
            exit 1
          fi
          
          echo "âœ… Frontend verification passed!"
          echo "   - index.html: present"
          echo "   - assets: ${ASSET_COUNT} files"
          echo ""
          echo "ðŸ“ Frontend build contents:"
          find web/dist -type f | head -20

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION_NUM=${VERSION#v}
          COMMIT_SHA=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT_SHA}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "Building ToughRADIUS ${VERSION} (${COMMIT_SHA})"

      - name: Verify Go Embed
        run: |
          echo "ðŸ” Verifying Go embed configuration..."
          
          # Check if static.go has the correct embed directive
          if ! grep -q '//go:embed dist/\*' web/static.go; then
            echo "âŒ Error: web/static.go missing embed directive!"
            exit 1
          fi
          
          # Test that the build can find embedded files
          echo "Testing Go build with embedded frontend..."
          CGO_ENABLED=0 go build -o /tmp/test_build main.go
          
          if [ ! -f "/tmp/test_build" ]; then
            echo "âŒ Error: Test build failed!"
            exit 1
          fi
          
          # Check binary size (should be > 10MB with embedded frontend)
          SIZE=$(stat -f%z /tmp/test_build 2>/dev/null || stat -c%s /tmp/test_build 2>/dev/null)
          if [ "$SIZE" -lt 10000000 ]; then
            echo "âš ï¸ Warning: Binary size (${SIZE} bytes) seems small. Frontend may not be embedded correctly."
          else
            echo "âœ… Binary size: ${SIZE} bytes - frontend appears to be embedded"
          fi
          
          rm -f /tmp/test_build
          echo "âœ… Go embed verification passed!"

      - name: Build binaries
        env:
          VERSION: ${{ steps.version.outputs.version }}
          COMMIT: ${{ steps.version.outputs.commit }}
          BUILD_TIME: ${{ steps.version.outputs.build_time }}
        run: |
          mkdir -p ./release
          LDFLAGS="-s -w -X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${COMMIT} -extldflags '-static'"
          
          # Build for Linux AMD64 (x86_64)
          echo "Building for Linux AMD64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_linux_amd64 main.go
          
          # Build for Linux ARM64 (aarch64)
          echo "Building for Linux ARM64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_linux_arm64 main.go
          
          # Build for Linux ARMv7
          echo "Building for Linux ARMv7..."
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_linux_armv7 main.go
          
          # Build for Linux RISC-V 64-bit
          echo "Building for Linux RISC-V 64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=riscv64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_linux_riscv64 main.go
          
          # Build for Linux LoongArch 64-bit
          echo "Building for Linux LoongArch 64..."
          CGO_ENABLED=0 GOOS=linux GOARCH=loong64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_linux_loong64 main.go
          
          # Build for macOS AMD64
          echo "Building for macOS AMD64..."
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_darwin_amd64 main.go
          
          # Build for macOS ARM64 (Apple Silicon)
          echo "Building for macOS ARM64..."
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_darwin_arm64 main.go
          
          # Build for Windows AMD64
          echo "Building for Windows AMD64..."
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_windows_amd64.exe main.go
          
          # Build for Windows ARM64
          echo "Building for Windows ARM64..."
          CGO_ENABLED=0 GOOS=windows GOARCH=arm64 go build -a -ldflags "${LDFLAGS}" -o ./release/toughradius_windows_arm64.exe main.go
          
          # Create checksums
          cd ./release
          sha256sum * > checksums.txt
          cd ..
          
          echo "Build completed!"
          ls -lah ./release/

      - name: Generate release notes from closed issues
        id: release_notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")
          
          echo "## ToughRADIUS ${VERSION}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“¦ Downloads" >> release_notes.md
          echo "" >> release_notes.md
          echo "| Platform | Architecture | File |" >> release_notes.md
          echo "|----------|--------------|------|" >> release_notes.md
          echo "| Linux | x86_64 (AMD64) | \`toughradius_linux_amd64\` |" >> release_notes.md
          echo "| Linux | ARM64 (aarch64) | \`toughradius_linux_arm64\` |" >> release_notes.md
          echo "| Linux | ARMv7 | \`toughradius_linux_armv7\` |" >> release_notes.md
          echo "| Linux | RISC-V 64 | \`toughradius_linux_riscv64\` |" >> release_notes.md
          echo "| Linux | LoongArch 64 | \`toughradius_linux_loong64\` |" >> release_notes.md
          echo "| macOS | x86_64 (Intel) | \`toughradius_darwin_amd64\` |" >> release_notes.md
          echo "| macOS | ARM64 (Apple Silicon) | \`toughradius_darwin_arm64\` |" >> release_notes.md
          echo "| Windows | x86_64 (AMD64) | \`toughradius_windows_amd64.exe\` |" >> release_notes.md
          echo "| Windows | ARM64 | \`toughradius_windows_arm64.exe\` |" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ³ Docker" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "docker pull talkincode/toughradius:${{ steps.version.outputs.version_num }}" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          
          # Fetch closed issues since last release
          if [ -n "$PREV_TAG" ]; then
            SINCE_DATE=$(git log -1 --format=%aI ${PREV_TAG})
            echo "### ðŸ”„ Changes since ${PREV_TAG}" >> release_notes.md
            echo "" >> release_notes.md
            
            # Get closed issues
            ISSUES=$(gh issue list --state closed --search "closed:>=${SINCE_DATE:0:10}" --json number,title,labels --limit 50 2>/dev/null || echo "[]")
            
            if [ "$ISSUES" != "[]" ] && [ -n "$ISSUES" ]; then
              echo "#### ðŸ› Bug Fixes" >> release_notes.md
              echo "$ISSUES" | jq -r '.[] | select(.labels | map(.name) | contains(["bug"])) | "- #\(.number) \(.title)"' >> release_notes.md 2>/dev/null || true
              echo "" >> release_notes.md
              
              echo "#### âœ¨ Features" >> release_notes.md
              echo "$ISSUES" | jq -r '.[] | select(.labels | map(.name) | contains(["enhancement"])) | "- #\(.number) \(.title)"' >> release_notes.md 2>/dev/null || true
              echo "" >> release_notes.md
              
              echo "#### ðŸ“ Other Changes" >> release_notes.md
              echo "$ISSUES" | jq -r '.[] | select((.labels | map(.name) | contains(["bug"]) | not) and (.labels | map(.name) | contains(["enhancement"]) | not)) | "- #\(.number) \(.title)"' >> release_notes.md 2>/dev/null || true
              echo "" >> release_notes.md
            fi
            
            # Get commits
            echo "#### ðŸ“‹ Commits" >> release_notes.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | head -20 >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "### ðŸ“Š Build Info" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **Version:** ${VERSION}" >> release_notes.md
          echo "- **Commit:** ${{ steps.version.outputs.commit }}" >> release_notes.md
          echo "- **Build Time:** ${{ steps.version.outputs.build_time }}" >> release_notes.md
          echo "- **Go Version:** 1.24" >> release_notes.md
          
          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ToughRADIUS ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'rc') }}
          files: |
            ./release/toughradius_linux_amd64
            ./release/toughradius_linux_arm64
            ./release/toughradius_linux_armv7
            ./release/toughradius_linux_riscv64
            ./release/toughradius_linux_loong64
            ./release/toughradius_darwin_amd64
            ./release/toughradius_darwin_arm64
            ./release/toughradius_windows_amd64.exe
            ./release/toughradius_windows_arm64.exe
            ./release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
