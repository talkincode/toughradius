#!/bin/bash
# ToughRADIUS Pre-commit Hook
# Âú®Êèê‰∫§ÂâçËøêË°åÂø´ÈÄüÊ£ÄÊü•ÔºåÁ°Æ‰øù‰ª£Á†ÅË¥®Èáè

set -e

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Running pre-commit checks...${NC}"

# Ëé∑ÂèñÊöÇÂ≠òÁöÑ Go Êñá‰ª∂
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo -e "${GREEN}‚úÖ No Go files staged, skipping checks${NC}"
    exit 0
fi

# 1. Ê£ÄÊü•‰ª£Á†ÅÊ†ºÂºè
echo -e "\n${YELLOW}üìù Checking code formatting...${NC}"
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}‚ùå The following files are not properly formatted:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run 'go fmt ./...' to fix${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ Code formatting OK${NC}"

# 2. ËøêË°å go vet
echo -e "\n${YELLOW}üîé Running go vet...${NC}"
if ! CGO_ENABLED=0 go vet ./... 2>&1; then
    echo -e "${RED}‚ùå go vet found issues${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ go vet OK${NC}"

# 3. Ê£ÄÊü•ÊòØÂê¶ÊúâË∞ÉËØï‰ª£Á†ÅÔºàÂèØÈÄâË≠¶ÂëäÔºâ
echo -e "\n${YELLOW}üêõ Checking for debug statements...${NC}"
DEBUG_PATTERNS="fmt.Print|log.Print|panic("
for file in $STAGED_GO_FILES; do
    # ÊéíÈô§ÊµãËØïÊñá‰ª∂ÂíåÁâπÂÆöÊñá‰ª∂
    if [[ "$file" == *"_test.go" ]] || [[ "$file" == "main.go" ]]; then
        continue
    fi
    
    # Ê£ÄÊü•Ë∞ÉËØïËØ≠Âè•Ôºà‰ªÖË≠¶ÂëäÔºå‰∏çÈòªÊ≠¢Êèê‰∫§Ôºâ
    if grep -n -E "^\s*(fmt\.Print|fmt\.Println)\(" "$file" 2>/dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Found fmt.Print in $file (consider using zap logger)${NC}"
    fi
done
echo -e "${GREEN}‚úÖ Debug check completed${NC}"

# 4. Âø´ÈÄüÁºñËØëÊ£ÄÊü•
echo -e "\n${YELLOW}üî® Running quick build check...${NC}"
if ! CGO_ENABLED=0 go build -o /dev/null ./... 2>&1; then
    echo -e "${RED}‚ùå Build failed${NC}"
    exit 1
fi
echo -e "${GREEN}‚úÖ Build check OK${NC}"

echo -e "\n${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0
