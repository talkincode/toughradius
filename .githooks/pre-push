#!/bin/bash
# ToughRADIUS Pre-push Hook
# åœ¨æ¨é€å‰è¿è¡Œå®Œæ•´æµ‹è¯•ï¼Œç¡®ä¿ç»ä¸æ¨é€æœ‰é—®é¢˜çš„ä»£ç 

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}       ToughRADIUS Pre-push Quality Gate${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date +%s)

# 1. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
echo -e "\n${YELLOW}ğŸ§ª Running full test suite...${NC}"
if ! CGO_ENABLED=0 go test ./... 2>&1; then
    echo -e "${RED}âŒ Tests failed! Push aborted.${NC}"
    echo -e "${YELLOW}Fix the failing tests before pushing.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… All tests passed${NC}"

# 2. è¿è¡Œä»£ç æ£€æŸ¥
echo -e "\n${YELLOW}ğŸ” Running go vet...${NC}"
if ! CGO_ENABLED=0 go vet ./... 2>&1; then
    echo -e "${RED}âŒ go vet found issues! Push aborted.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… go vet OK${NC}"

# 3. æ£€æŸ¥ä»£ç æ ¼å¼
echo -e "\n${YELLOW}ğŸ“ Checking code formatting...${NC}"
UNFORMATTED=$(gofmt -l . 2>/dev/null | grep -v vendor || true)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}âŒ The following files are not properly formatted:${NC}"
    echo "$UNFORMATTED"
    echo -e "${YELLOW}Run 'go fmt ./...' to fix${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Code formatting OK${NC}"

# 4. å®Œæ•´æ„å»ºéªŒè¯
echo -e "\n${YELLOW}ğŸ”¨ Running full build verification...${NC}"
if ! CGO_ENABLED=0 go build ./... 2>&1; then
    echo -e "${RED}âŒ Build failed! Push aborted.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Build OK${NC}"

# 5. æ£€æŸ¥ go.mod å’Œ go.sum æ˜¯å¦åŒæ­¥
echo -e "\n${YELLOW}ğŸ“¦ Checking module dependencies...${NC}"
go mod tidy
if ! git diff --quiet go.mod go.sum 2>/dev/null; then
    echo -e "${YELLOW}âš ï¸  Warning: go.mod or go.sum changed after 'go mod tidy'${NC}"
    echo -e "${YELLOW}   Consider committing these changes${NC}"
fi
echo -e "${GREEN}âœ… Module dependencies OK${NC}"

# 6. è¿è¡Œ golangci-lintï¼ˆå¦‚æœå·²å®‰è£…ï¼‰
if command -v golangci-lint &> /dev/null; then
    echo -e "\n${YELLOW}ğŸ” Running golangci-lint...${NC}"
    if ! golangci-lint run --timeout=5m 2>&1; then
        echo -e "${YELLOW}âš ï¸  golangci-lint found issues (non-blocking)${NC}"
    else
        echo -e "${GREEN}âœ… golangci-lint OK${NC}"
    fi
else
    echo -e "\n${YELLOW}ğŸ’¡ Tip: Install golangci-lint for additional checks:${NC}"
    echo -e "   brew install golangci-lint"
fi

# è®¡ç®—è€—æ—¶
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-push checks passed! (${DURATION}s)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0
    echo -e "\n${YELLOW}ğŸ” Running golangci-lint...${NC}"
    if ! golangci-lint run --timeout=5m 2>&1; then
        echo -e "${YELLOW}âš ï¸  golangci-lint found issues (non-blocking)${NC}"
    else
        echo -e "${GREEN}âœ… golangci-lint OK${NC}"
    fi
else
    echo -e "\n${YELLOW}ğŸ’¡ Tip: Install golangci-lint for additional checks:${NC}"
    echo -e "   brew install golangci-lint"
fi

# è®¡ç®—è€—æ—¶
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-push checks passed! (${DURATION}s)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0
